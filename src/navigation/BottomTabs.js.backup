// BottomTabs.js
import React, { useMemo, useEffect, useRef } from 'react';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import Icon from 'react-native-vector-icons/Ionicons'; // You can use other icon sets too
import { View, Text, StyleSheet, Platform, Animated } from 'react-native';
import ShoppingHomeScreen from '../screen/ShoppingHomeScreen';
import WishlistScreen from '../WishlistScreen';
import CelebritiesScreen from '../screen/CelebritiesScreen';
import CartScreen from '../CartScreen';
import ProfileScreen from '../ProfileScreen';
import SettingsScreen from '../screen/SettingsScreen';
import NewHome from '../screen/NewHome';
import { useTheme } from '../context/ThemeContext';
import i18n from '../i18n';

// Dummy Screens
const Home = () => <View style={{ flex: 1, backgroundColor: 'white' }} />;
const Favorites = () => <View style={{ flex: 1, backgroundColor: 'white' }} />;
const Tasks = () => <View style={{ flex: 1, backgroundColor: 'white' }} />;
const Mail = () => <View style={{ flex: 1, backgroundColor: 'white' }} />;
const Profile = () => <View style={{ flex: 1, backgroundColor: 'white' }} />;

const Tab = createBottomTabNavigator();

const TAB_META = {
    Home: { label: 'Home', active: 'home', inactive: 'home-outline' },
    Favorites: { label: 'Wishlist', active: 'heart', inactive: 'heart-outline' },
    Tasks: { label: 'Celebrities', active: 'star', inactive: 'star-outline' },
    cart: { label: 'Cart', active: 'cart', inactive: 'cart-outline' },
    Profile: { label: 'Profile', active: 'person', inactive: 'person-outline' },
};

const BottomTabs = () => {
    const { theme, isDark } = useTheme();

    const tabBarStyles = useMemo(() => createTabBarStyles(theme, isDark), [theme, isDark]);

    return (
        <Tab.Navigator
            screenOptions={({ route }) => {
                const meta = TAB_META[route.name] || { label: route.name, active: 'ellipse', inactive: 'ellipse-outline' };
                return {
                    headerShown: false,
                    tabBarHideOnKeyboard: true,
                    tabBarActiveTintColor: theme.p1,
                    tabBarInactiveTintColor: isDark ? theme.sub : '#8E9CB5',
                    tabBarLabelStyle: { fontSize: 12, fontWeight: '700', marginBottom: 4 },
                    tabBarItemStyle: { paddingVertical: 4 },
                    tabBarStyle: tabBarStyles.tabBar,
                    tabBarLabel: meta.label,
                    tabBarIcon: ({ focused, color }) => {
                        if (route.name === 'Tasks') {
                            return (
                                <CenterIconButton
                                    focused={focused}
                                    iconName={focused ? meta.active : meta.inactive}
                                    styles={tabBarStyles}
                                />
                            );
                        }

                        return (
                            <View style={tabBarStyles.tabIcon}>
                                <Icon
                                    name={focused ? meta.active : meta.inactive}
                                    size={22}
                                    color={color}
                                />
                            </View>
                        );
                    },
                };
            }}
        >
            <Tab.Screen
                name="Home"
                component={NewHome}
                key={i18n?.language || 'en'} // Force re-render on language change
            />
            <Tab.Screen name="Favorites" component={WishlistScreen} />
            <Tab.Screen name="Tasks" component={CelebritiesScreen} />
            <Tab.Screen name="cart" component={CartScreen} />
            <Tab.Screen name="Profile" component={SettingsScreen} />
        </Tab.Navigator>
    );
};

export default BottomTabs;

// Animated Center Icon Component
const CenterIconButton = ({ focused, iconName, styles }) => {
    const scaleAnim = useRef(new Animated.Value(1)).current;
    const pulseAnim = useRef(new Animated.Value(1)).current;

    useEffect(() => {
        if (focused) {
            // Scale animation on focus
            Animated.sequence([
                Animated.spring(scaleAnim, {
                    toValue: 1.15,
                    useNativeDriver: true,
                    tension: 50,
                    friction: 3,
                }),
                Animated.spring(scaleAnim, {
                    toValue: 1,
                    useNativeDriver: true,
                    tension: 50,
                    friction: 3,
                }),
            ]).start();

            // Continuous pulse animation
            Animated.loop(
                Animated.sequence([
                    Animated.timing(pulseAnim, {
                        toValue: 1.1,
                        duration: 1000,
                        useNativeDriver: true,
                    }),
                    Animated.timing(pulseAnim, {
                        toValue: 1,
                        duration: 1000,
                        useNativeDriver: true,
                    }),
                ])
            ).start();
        } else {
            // Reset animations when not focused
            Animated.parallel([
                Animated.timing(scaleAnim, {
                    toValue: 1,
                    duration: 200,
                    useNativeDriver: true,
                }),
                Animated.timing(pulseAnim, {
                    toValue: 1,
                    duration: 200,
                    useNativeDriver: true,
                }),
            ]).start();
        }
    }, [focused]);

    return (
        <View style={styles.centerIconWrap}>
            <Animated.View
                style={[
                    styles.centerIconCircle,
                    focused && styles.centerIconCircleActive,
                    {
                        transform: [
                            { scale: scaleAnim },
                            { scale: pulseAnim },
                        ],
                    },
                ]}
            >
                <Icon
                    name={iconName}
                    size={26}
                    color="#fff"
                />
            </Animated.View>
        </View>
    );
};

const createTabBarStyles = (theme, isDark) => StyleSheet.create({
    tabBar: {
        height: 76,
        paddingBottom: 10,
        paddingTop: 6,
        backgroundColor: isDark ? theme.card : '#ffffff',
        borderTopWidth: 1,
        borderTopColor: isDark ? theme.line : 'rgba(0,0,0,0.05)',
        elevation: 18,
        shadowColor: isDark ? '#000' : '#000',
        shadowOpacity: isDark ? 0.3 : 0.12,
        shadowOffset: { width: 0, height: -2 },
        shadowRadius: 12,
    },
    tabIcon: {
        alignItems: 'center',
        justifyContent: 'center',
    },
    centerIconWrap: {
        alignItems: 'center',
        justifyContent: 'center',
        marginTop: -22,
    },
    centerIconCircle: {
        width: 64,
        height: 64,
        borderRadius: 32,
        backgroundColor: theme.p1,
        alignItems: 'center',
        justifyContent: 'center',
        borderWidth: 4,
        borderColor: isDark ? theme.card : '#ffffff',
        shadowColor: theme.p1,
        shadowOpacity: 0.35,
        shadowOffset: { width: 0, height: 6 },
        shadowRadius: 8,
        elevation: 8,
    },
    centerIconCircleActive: {
        backgroundColor: theme.p2,
    },
});

