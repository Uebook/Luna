// src/screens/ProductDetailScreen.js
import React, { useMemo, useState, useEffect, useCallback } from 'react';
import {
    View,
    Text,
    StyleSheet,
    Image,
    FlatList,
    TouchableOpacity,
    SafeAreaView,
    ScrollView,
    Dimensions,
    Platform,
    Alert,
    Modal,
    ActivityIndicator,
    StatusBar
} from 'react-native';
import Icon from 'react-native-vector-icons/Ionicons';
import LinearGradient from 'react-native-linear-gradient';
import { useRoute, useNavigation, useFocusEffect } from '@react-navigation/native';
import RenderHtml from 'react-native-render-html';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { useTheme } from '../context/ThemeContext';
import StandardHeader from '../components/StandardHeader';
import { SkeletonProductDetailScreen } from '../components/SkeletonLoader';
import { useSkeletonLoader } from '../hooks/useSkeletonLoader';

const { width: W, height: H } = Dimensions.get('window');
const HERO_H = Math.min(420, H * 0.5);

const CART_STORAGE_KEY = 'user_cart';
const USER_STORAGE_KEY = 'luna_user';

const ProductDetailScreen = () => {
    const { theme, isDark } = useTheme();
    const THEME = theme;
    const styles = useMemo(() => createStyles(THEME, isDark), [THEME, isDark]);
    const navigation = useNavigation();
    const route = useRoute();
    const product = route?.params?.product;

    const [galleryIndex, setGalleryIndex] = useState(0);
    const [imageLoading, setImageLoading] = useState(true);
    const [cartQuantity, setCartQuantity] = useState(0);
    const [isAddingToCart, setIsAddingToCart] = useState(false);
    const [isWishlisted, setIsWishlisted] = useState(false);
    const [wishlistLoading, setWishlistLoading] = useState(false);
    const [userId, setUserId] = useState(null);
    const [userLoading, setUserLoading] = useState(true);

    // Selection States
    const [selectedSize, setSelectedSize] = useState(null);
    const [selectedColor, setSelectedColor] = useState(null);

    // Modal States
    const [sizeChartOpen, setSizeChartOpen] = useState(false);
    const [reviewsOpen, setReviewsOpen] = useState(false);
    const [policyOpen, setPolicyOpen] = useState(false);

    // Delivery State
    const [selectedDelivery, setSelectedDelivery] = useState('standard');

    // Load user data from AsyncStorage
    const loadUserData = useCallback(async () => {
        try {
            const savedUser = await AsyncStorage.getItem(USER_STORAGE_KEY);

            if (savedUser) {
                const parsed = JSON.parse(savedUser);
                // Extract user ID from different possible field names
                const userId = parsed.user.id
                console.log('Loaded user from AsyncStorageparsed:', parsed);

                if (userId) {
                    setUserId(userId);
                    console.log('User ID set to:', userId);
                } else {
                    setUserId(null);
                    console.log('No user ID found in user data');
                }
            } else {
                setUserId(null);
                console.log('No user found in AsyncStorage');
            }
        } catch (error) {
            console.log('Error loading user data:', error);
            setUserId(null);
        } finally {
            setUserLoading(false);
        }
    }, []);

    // Load user data on component mount
    useEffect(() => {
        loadUserData();
        // Simulate initial loading
        const timer = setTimeout(() => setInitialLoading(false), 800);
        return () => clearTimeout(timer);
    }, [loadUserData, setInitialLoading]);

    // Load cart quantity on component mount and when selections change
    useEffect(() => {
        if (!userLoading) {
            loadCartQuantity();
            initializeSelections();
            addToRecentlyViewed(); // Add to recently viewed when component mounts
            checkWishlistStatus(); // Check if product is in wishlist
        }
    }, [product, userLoading]);

    // Reload cart quantity when size or color selection changes
    useEffect(() => {
        loadCartQuantity();
    }, [selectedSize, selectedColor]);

    // Also reload when screen comes into focus
    useFocusEffect(
        React.useCallback(() => {
            loadCartQuantity();
            loadUserData(); // Reload user data when screen comes into focus
        }, [loadCartQuantity, loadUserData])
    );

    // API call to add product to recently viewed
    const addToRecentlyViewed = async () => {
        if (!product?.id || !userId) {
            console.log('Cannot add to recently viewed - missing product ID or user ID');
            return;
        }

        try {
            const response = await fetch('https://luna-api.proteinbros.in/public/api/v1/screen/recently-viewed/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    product_id: product.id
                })
            });

            const data = await response.json();

            if (!response.ok) {
                console.log('Recently viewed API error:', data);
            } else {
                console.log('Added to recently viewed:', data);
            }
        } catch (error) {
            console.log('Error adding to recently viewed:', error);
        }
    };

    // API call to toggle wishlist
    const toggleWishlist = async () => {
        if (!product?.id) {
            Alert.alert('Error', 'Product information is missing');
            return;
        }

        if (!userId) {
            Alert.alert('Login Required', 'Please login to add items to your wishlist');
            return;
        }

        setWishlistLoading(true);
        try {
            const response = await fetch('https://luna-api.proteinbros.in/public/api/v1/screen/wishlist/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    product_id: product.id
                })
            });

            const data = await response.json();

            if (response.ok) {
                setIsWishlisted(!isWishlisted);
                Alert.alert(
                    isWishlisted ? 'Removed from Wishlist' : 'Added to Wishlist',
                    isWishlisted
                        ? 'Product has been removed from your wishlist.'
                        : 'Product has been added to your wishlist!'
                );
            } else {
                Alert.alert('Error', data.message || 'Failed to update wishlist');
            }
        } catch (error) {
            console.log('Wishlist API error:', error);
            Alert.alert('Error', 'Failed to update wishlist. Please try again.');
        } finally {
            setWishlistLoading(false);
        }
    };

    // Check if product is in wishlist
    const checkWishlistStatus = async () => {
        if (!userId || !product?.id) {
            setIsWishlisted(false);
            return;
        }

        // For now, we'll set a default state
        // You can implement actual API call to check wishlist status here
        // Example: fetch user's wishlist and check if product exists
        setIsWishlisted(false);
    };

    // Handle missing product data
    if (!product) {
        if (initialLoading) {
            return (
                <SafeAreaView style={styles.safe}>
                    <SkeletonProductDetailScreen />
                </SafeAreaView>
            );
        }
        return (
            <SafeAreaView style={[styles.safe, styles.centerContent]}>
                <Text style={styles.errorText}>Product data missing.</Text>
                <TouchableOpacity style={styles.retryButton} onPress={() => navigation.goBack()}>
                    <Text style={styles.retryButtonText}>Go Back</Text>
                </TouchableOpacity>
            </SafeAreaView>
        );
    }

    // Show skeleton while initial loading
    if (initialLoading) {
        return (
            <SafeAreaView style={styles.safe}>
                <SkeletonProductDetailScreen />
            </SafeAreaView>
        );
    }

    // Parse size and color data from API
    const productSizes = useMemo(() => {
        if (!product.size) return [];
        try {
            const sizes = product.size.split(',').map(s => s.trim()).filter(s => s);
            const sizeQtys = product.size_qty ? product.size_qty.split(',').map(q => parseInt(q.trim()) || 0) : [];
            const sizePrices = product.size_price ? product.size_price.split(',').map(p => parseFloat(p.trim()) || product.price) : [];

            return sizes.map((size, index) => ({
                size: size,
                quantity: sizeQtys[index] !== undefined ? sizeQtys[index] : product.stock || 0,
                price: sizePrices[index] !== undefined ? sizePrices[index] : product.price,
                id: `size-${index}-${size}`,
                inStock: (sizeQtys[index] || product.stock || 0) > 0
            }));
        } catch (error) {
            console.log('Error parsing sizes:', error);
            return [];
        }
    }, [product]);

    // Process color array - remove duplicates and create color objects
    const productColors = useMemo(() => {
        if (!product.color) return [];
        try {
            const colors = product.color.split(',').map(c => c.trim()).filter(c => c);
            const uniqueColors = [...new Set(colors)];

            return uniqueColors.map((color, index) => ({
                color: color,
                name: color,
                id: `color-${index}-${color}`,
                hex: color
            }));
        } catch (error) {
            console.log('Error parsing colors:', error);
            return [];
        }
    }, [product]);

    // Helper function to get color name from hex
    const getColorName = (hex) => {
        const colorMap = {
            '#000000': 'Black',
            '#f41c1c': 'Red',
            '#3c34d5': 'Blue',
            '#c12ec8': 'Purple',
            '#007137': 'Green',
            '#FFFFFF': 'White',
            '#FFA500': 'Orange',
            '#FFFF00': 'Yellow',
            '#808080': 'Gray'
        };
        return colorMap[hex?.toLowerCase()] || `Color ${hex}`;
    };

    const hasSizes = productSizes.length > 0;
    const hasColors = productColors.length > 0;
    const requiresSelection = hasSizes || hasColors;

    // Delivery options for Bahrain
    const deliveryOptions = [
        { id: 'standard', name: 'Standard 5-7 days', price: 3.00, days: '5-7 days' },
        { id: 'express', name: 'Express 1-2 days', price: 12.00, days: '1-2 days' }
    ];

    // Mock reviews data
    const reviews = [
        {
            id: 1,
            user: 'BR Veronika',
            rating: 4,
            comment: 'Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed',
            date: '2 days ago'
        },
        {
            id: 2,
            user: 'Ahmed Ali',
            rating: 5,
            comment: 'Excellent product quality and fast delivery in Bahrain!',
            date: '1 week ago'
        }
    ];

    const popularProducts = [
        { id: '1', name: 'Lorem ipsum dolor sit amet consectetur', price: 17.00, image: 'https://via.placeholder.com/100x100' },
        { id: '2', name: 'Lorem ipsum dolor sit amet consectetur', price: 17.00, image: 'https://via.placeholder.com/100x100' },
        { id: '3', name: 'Lorem ipsum dolor sit amet consectetur', price: 17.00, image: 'https://via.placeholder.com/100x100' },
        { id: '4', name: 'Lorem ipsum dolor sit amet consectetur', price: 17.00, image: 'https://via.placeholder.com/100x100' }
    ];

    // Initialize default selections
    const initializeSelections = () => {
        if (hasSizes) {
            const availableSize = productSizes.find(size => size.inStock) || productSizes[0];
            setSelectedSize(availableSize);
        }
        if (hasColors) {
            setSelectedColor(productColors[0]);
        }
    };

    // Calculate current price based on selections
    const currentPrice = useMemo(() => {
        return selectedSize ? selectedSize.price : product.price;
    }, [selectedSize, product.price]);

    const previousPrice = product.previous_price;
    const discount = previousPrice && currentPrice ?
        Math.round(((previousPrice - currentPrice) / previousPrice) * 100) : 0;
    const hasDiscount = discount > 0;

    // Get available stock for selected size
    const availableStock = useMemo(() => {
        if (selectedSize && selectedSize.quantity !== null) {
            return selectedSize.quantity;
        }
        return product.stock || 0;
    }, [selectedSize, product.stock]);

    const isInStock = availableStock > 0;

    // Cart functions
    const loadCartQuantity = useCallback(async () => {
        try {
            const cartData = await AsyncStorage.getItem(CART_STORAGE_KEY);
            if (cartData) {
                const cart = JSON.parse(cartData);

                // Find the exact item with current selections
                const cartItem = cart.find(item =>
                    item.id === product.id &&
                    item.selectedSize === (selectedSize?.size || '') &&
                    item.selectedColor === (selectedColor?.color || '')
                );

                const quantity = cartItem ? cartItem.quantity : 0;
                console.log('Cart quantity loaded:', quantity, 'for product:', product.id, 'size:', selectedSize?.size, 'color:', selectedColor?.color);
                setCartQuantity(quantity);
            } else {
                console.log('No cart data found');
                setCartQuantity(0);
            }
        } catch (error) {
            console.log('Error loading cart:', error);
            setCartQuantity(0);
        }
    }, [product.id, selectedSize?.size, selectedColor?.color]);

    const updateCart = async (newQuantity) => {
        try {
            if (requiresSelection) {
                if (hasSizes && !selectedSize) {
                    Alert.alert('Size Required', 'Please select a size before adding to cart.');
                    return;
                }
                if (hasColors && !selectedColor) {
                    Alert.alert('Color Required', 'Please select a color before adding to cart.');
                    return;
                }
            }

            if (newQuantity > availableStock) {
                Alert.alert('Stock Limit', `Only ${availableStock} items available in stock.`);
                return;
            }

            const cartData = await AsyncStorage.getItem(CART_STORAGE_KEY);
            let cart = cartData ? JSON.parse(cartData) : [];

            const itemIdentifier = {
                id: product.id,
                selectedSize: selectedSize?.size || '',
                selectedColor: selectedColor?.color || ''
            };

            const existingItemIndex = cart.findIndex(item =>
                item.id === itemIdentifier.id &&
                item.selectedSize === itemIdentifier.selectedSize &&
                item.selectedColor === itemIdentifier.selectedColor
            );

            if (newQuantity > 0) {
                const cartItem = {
                    ...itemIdentifier,
                    name: product.name,
                    price: currentPrice,
                    previous_price: previousPrice,
                    image: getImageUrl(product.image) || getImageUrl(product.thumbnail),
                    quantity: newQuantity,
                    sku: product.sku,
                    stock: availableStock,
                    size: selectedSize?.size,
                    color: selectedColor?.color,
                    colorName: selectedColor?.name,
                    colorHex: selectedColor?.hex,
                    baseProduct: product
                };

                if (existingItemIndex >= 0) {
                    cart[existingItemIndex] = cartItem;
                } else {
                    cart.push(cartItem);
                }
            } else {
                if (existingItemIndex >= 0) {
                    cart.splice(existingItemIndex, 1);
                }
            }

            await AsyncStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            setCartQuantity(newQuantity);

            if (newQuantity === 1 && existingItemIndex === -1) {
                let message = `${product.name} added to cart!`;
                if (selectedSize) message += `\nSize: ${selectedSize.size}`;
                if (selectedColor) message += `\nColor: ${selectedColor.name}`;
                Alert.alert('ðŸŽ‰ Added to Cart', message);
            }

        } catch (error) {
            console.log('Error updating cart:', error);
            Alert.alert('Error', 'Failed to update cart. Please try again.');
        }
    };

    const handleAddToCart = async () => {
        if (requiresSelection) {
            if (hasSizes && !selectedSize) {
                Alert.alert('Selection Required', 'Please select a size before adding to cart.');
                return;
            }
            if (hasColors && !selectedColor) {
                Alert.alert('Selection Required', 'Please select a color before adding to cart.');
                return;
            }
        }

        setIsAddingToCart(true);
        await updateCart(1);
        setIsAddingToCart(false);
    };

    const handleIncreaseQuantity = () => {
        const newQuantity = cartQuantity + 1;
        if (newQuantity <= availableStock) {
            updateCart(newQuantity);
        } else {
            Alert.alert('Stock Limit', `Only ${availableStock} items available in stock.`);
        }
    };

    const handleDecreaseQuantity = () => {
        if (cartQuantity > 1) {
            updateCart(cartQuantity - 1);
        } else {
            updateCart(0);
        }
    };

    const handleBuyNow = async () => {
        if (requiresSelection) {
            if (hasSizes && !selectedSize) {
                Alert.alert('Selection Required', 'Please select a size before adding to cart.');
                return;
            }
            if (hasColors && !selectedColor) {
                Alert.alert('Selection Required', 'Please select a color before adding to cart.');
                return;
            }
        }

        setIsAddingToCart(true);
        if (cartQuantity === 0) {
            await updateCart(1);
        }
        setIsAddingToCart(false);
        navigation.navigate('CartScreen');
    };

    // Image URL construction
    const getImageUrl = (imagePath) => {
        if (!imagePath) return null;
        const cleanPath = imagePath.startsWith('/') ? imagePath.slice(1) : imagePath;
        return `${cleanPath}`;
    };

    // Hero images
    const heroImages = useMemo(() => {
        const images = [];
        if (product.image) {
            const mainImageUrl = getImageUrl(product.image);
            if (mainImageUrl) images.push(mainImageUrl);
        }
        if (product.thumbnail && images.length === 0) {
            const thumbImageUrl = getImageUrl("https://proteinbros.in/assets/images/products/" + product.thumbnail);
            if (thumbImageUrl) images.push(thumbImageUrl);
        }
        if (images.length === 0) {
            images.push('https://via.placeholder.com/600x600/FFFFFF/666666?text=No+Image+Available');
        }
        return images;
    }, [product]);

    // Format price with KWD
    const formatPrice = (price) => {
        return `${parseFloat(price).toFixed(3)} BHD`;
    };

    // Product details
    const productDetails = product.details || 'No description available.';
    const productName = product.name || 'Product Name';
    const productSku = product.sku || 'SKU not available';

    // Image loading handler
    const handleImageLoad = () => {
        setImageLoading(false);
    };

    const renderHeroImage = ({ item, index }) => (
        <View style={styles.heroImageContainer}>
            {imageLoading && index === 0 && (
                <View style={styles.loadingContainer}>
                    <ActivityIndicator size="large" color={THEME.p1} />
                </View>
            )}
            <Image
                source={{ uri: item }}
                style={styles.heroImg}
                onLoad={() => index === 0 && handleImageLoad()}
                resizeMode="cover"
            />
        </View>
    );

    const renderColorOption = ({ item }) => {
        const isSelected = selectedColor?.color === item.color;
        return (
            <TouchableOpacity
                style={[
                    styles.colorOption,
                    isSelected && styles.colorOptionSelected
                ]}
                onPress={() => setSelectedColor(item)}
                activeOpacity={0.7}
            >
                <View style={styles.colorCircleWrapper}>
                    <View style={[styles.colorCircle, { backgroundColor: item.hex || item.color }]} />
                    {isSelected && (
                        <View style={styles.colorCheckmark}>
                            <Icon name="checkmark" size={14} color={THEME.white} />
                        </View>
                    )}
                </View>
                <Text style={[
                    styles.colorText,
                    isSelected && styles.colorTextSelected
                ]} numberOfLines={1}>
                    {item.name}
                </Text>
            </TouchableOpacity>
        );
    };

    const renderPopularProduct = ({ item }) => (
        <View style={styles.popularProductCard}>
            <Image source={{ uri: item.image }} style={styles.popularProductImage} />
            <Text style={styles.popularProductName} numberOfLines={2}>{item.name}</Text>
            <Text style={styles.popularProductPrice}>{(item.price)}</Text>
        </View>
    );

    // Size Guide Modal for Bahrain
    const SizeGuideModal = () => (
        <Modal
            visible={sizeChartOpen}
            animationType="slide"
            transparent={true}
            onRequestClose={() => setSizeChartOpen(false)}
        >
            <View style={styles.modalOverlay}>
                <View style={styles.modalContent}>
                    <View style={styles.modalHeader}>
                        <Text style={styles.modalTitle}>Size Guide - Bahrain</Text>
                        <TouchableOpacity
                            onPress={() => setSizeChartOpen(false)}
                            style={styles.closeButton}
                        >
                            <Icon name="x" size={24} color={THEME.muted} />
                        </TouchableOpacity>
                    </View>
                    <ScrollView style={styles.sizeGuideContent}>
                        <Text style={styles.sizeGuideText}>
                            Find your perfect fit with our Bahrain size guide:
                        </Text>

                        <View style={styles.sizeTable}>
                            <View style={styles.tableHeader}>
                                <Text style={styles.tableHeaderText}>Intl Size</Text>
                                <Text style={styles.tableHeaderText}>Bahrain Size</Text>
                                <Text style={styles.tableHeaderText}>Chest (cm)</Text>
                                <Text style={styles.tableHeaderText}>Waist (cm)</Text>
                            </View>
                            {[
                                { intl: 'XS', bh: '32', chest: '81-86', waist: '66-71' },
                                { intl: 'S', bh: '34', chest: '86-91', waist: '71-76' },
                                { intl: 'M', bh: '36', chest: '91-96', waist: '76-81' },
                                { intl: 'L', bh: '38', chest: '96-102', waist: '81-86' },
                                { intl: 'XL', bh: '40', chest: '102-107', waist: '86-91' },
                                { intl: 'XXL', bh: '42', chest: '107-112', waist: '91-97' }
                            ].map((size) => (
                                <View key={size.intl} style={styles.tableRow}>
                                    <Text style={styles.tableCell}>{size.intl}</Text>
                                    <Text style={styles.tableCell}>{size.bh}</Text>
                                    <Text style={styles.tableCell}>{size.chest}</Text>
                                    <Text style={styles.tableCell}>{size.waist}</Text>
                                </View>
                            ))}
                        </View>

                        <View style={styles.sizeTip}>
                            <Icon name="info" size={20} color={THEME.p1} />
                            <Text style={styles.sizeTipText}>
                                All measurements in centimeters. For best fit, measure your body and compare.
                            </Text>
                        </View>
                    </ScrollView>
                </View>
            </View>
        </Modal>
    );

    // Reviews Modal
    const ReviewsModal = () => (
        <Modal
            visible={reviewsOpen}
            animationType="slide"
            transparent={true}
            onRequestClose={() => setReviewsOpen(false)}
        >
            <View style={styles.modalOverlay}>
                <View style={styles.modalContent}>
                    <View style={styles.modalHeader}>
                        <Text style={styles.modalTitle}>Customer Reviews - Bahrain</Text>
                        <TouchableOpacity
                            onPress={() => setReviewsOpen(false)}
                            style={styles.closeButton}
                        >
                            <Icon name="x" size={24} color={THEME.muted} />
                        </TouchableOpacity>
                    </View>
                    <ScrollView style={styles.reviewsContent}>
                        <Text style={styles.reviewsCount}>{reviews.length} Reviews</Text>
                        {reviews.map((review) => (
                            <View key={review.id} style={styles.reviewItem}>
                                <View style={styles.reviewHeader}>
                                    <Text style={styles.reviewUser}>{review.user}</Text>
                                    <Text style={styles.reviewDate}>{review.date}</Text>
                                </View>
                                <View style={styles.ratingStars}>
                                    {[1, 2, 3, 4, 5].map((star) => (
                                        <Icon
                                            key={star}
                                            name="star"
                                            size={16}
                                            color={star <= review.rating ? "#FFD700" : THEME.line}
                                        />
                                    ))}
                                </View>
                                <Text style={styles.reviewComment}>{review.comment}</Text>
                            </View>
                        ))}
                    </ScrollView>
                </View>
            </View>
        </Modal>
    );

    // Policy Modal
    const PolicyModal = () => (
        <Modal
            visible={policyOpen}
            animationType="slide"
            transparent={true}
            onRequestClose={() => setPolicyOpen(false)}
        >
            <View style={styles.modalOverlay}>
                <View style={styles.modalContent}>
                    <View style={styles.modalHeader}>
                        <Text style={styles.modalTitle}>Product Policy</Text>
                        <TouchableOpacity
                            onPress={() => setPolicyOpen(false)}
                            style={styles.closeButton}
                        >
                            <Icon name="x" size={24} color={THEME.muted} />
                        </TouchableOpacity>
                    </View>
                    <ScrollView style={styles.policyContent}>
                        {product.policy ? (
                            <RenderHtml
                                contentWidth={W - 32}
                                source={{ html: product.policy }}
                                baseStyle={styles.policyText}
                            />
                        ) : (
                            <Text style={styles.policyText}>
                                No policy information available for this product.
                            </Text>
                        )}
                    </ScrollView>
                </View>
            </View>
        </Modal>
    );

    return (
        <View style={styles.safe}>
            <StatusBar barStyle="dark-content" backgroundColor={THEME.white} />
            <StandardHeader
                title=""
                navigation={navigation}
                showGradient={true}
            />
            <ScrollView showsVerticalScrollIndicator={false} style={styles.scrollView}>

                {/* HERO SECTION */}
                <View style={styles.heroWrap}>
                    <FlatList
                        data={heroImages}
                        horizontal
                        pagingEnabled
                        showsHorizontalScrollIndicator={false}
                        keyExtractor={(item, idx) => `hero-${idx}`}
                        onMomentumScrollEnd={(e) => {
                            const idx = Math.round(e.nativeEvent.contentOffset.x / W);
                            setGalleryIndex(idx);
                        }}
                        renderItem={renderHeroImage}
                    />

                    {/* Image Indicators */}
                    {heroImages.length > 1 && (
                        <View style={styles.imageIndicators}>
                            {heroImages.map((_, idx) => (
                                <View
                                    key={idx}
                                    style={[
                                        styles.indicatorDot,
                                        idx === galleryIndex && styles.indicatorDotActive
                                    ]}
                                />
                            ))}
                        </View>
                    )}

                    {/* Action Buttons */}
                    <SafeAreaView style={styles.heroTopRow}>
                        <View style={styles.headerRight}>
                            <TouchableOpacity
                                style={styles.iconBtn}
                                onPress={toggleWishlist}
                                disabled={wishlistLoading || !userId}
                            >
                                {wishlistLoading ? (
                                    <ActivityIndicator size="small" color={THEME.red} />
                                ) : (
                                    <Icon
                                        name={isWishlisted ? "heart" : "heart-outline"}
                                        size={22}
                                        color={isWishlisted ? THEME.red : (!userId ? THEME.muted : THEME.ink)}
                                    />
                                )}
                            </TouchableOpacity>
                            <TouchableOpacity style={styles.iconBtn}>
                                <Icon name="share-outline" size={22} color={THEME.ink} />
                            </TouchableOpacity>
                        </View>
                    </SafeAreaView>
                </View>

                {/* PRODUCT INFO */}
                <View style={styles.section}>
                    <View style={styles.priceRow}>
                        <View style={styles.priceContainer}>
                            <Text style={styles.price}>{formatPrice(currentPrice)}</Text>
                            {hasDiscount && (
                                <Text style={styles.originalPrice}>{formatPrice(previousPrice)}</Text>
                            )}
                        </View>
                        {hasDiscount && (
                            <LinearGradient
                                colors={[THEME.red, THEME.red]}
                                start={{ x: 0, y: 0 }}
                                end={{ x: 1, y: 1 }}
                                style={styles.discountBadge}
                            >
                                <Text style={styles.discountText}>-{discount}%</Text>
                            </LinearGradient>
                        )}
                    </View>

                    <Text style={styles.productTitle}>{productName}</Text>

                    <View style={styles.metaRow}>
                        <View style={styles.skuBadge}>
                            <Icon name="barcode-outline" size={14} color={THEME.gray} />
                            <Text style={styles.productSku}>{productSku}</Text>
                        </View>
                        <View style={[styles.stockBadge, isInStock ? styles.stockBadgeIn : styles.stockBadgeOut]}>
                            <Icon
                                name={isInStock ? "checkmark-circle" : "close-circle"}
                                size={14}
                                color={isInStock ? THEME.success : THEME.red}
                            />
                            <Text style={[styles.stockText, isInStock ? styles.inStock : styles.outOfStock]}>
                                {isInStock ? `${availableStock} available` : 'Out of Stock'}
                            </Text>
                        </View>
                    </View>
                </View>

                {/* VARIATIONS */}
                {(hasColors || hasSizes) && (
                    <View style={styles.section}>
                        <Text style={styles.sectionTitle}>Select Options</Text>

                        {/* Color Selection */}
                        {hasColors && (
                            <View style={styles.variationBlock}>
                                <View style={styles.variationHeader}>
                                    <Text style={styles.variationLabel}>Color</Text>
                                    {selectedColor && (
                                        <Text style={styles.selectedVariationText}>{selectedColor.name}</Text>
                                    )}
                                </View>
                                <FlatList
                                    horizontal
                                    data={productColors}
                                    keyExtractor={(item) => item.id}
                                    showsHorizontalScrollIndicator={false}
                                    contentContainerStyle={styles.colorsList}
                                    renderItem={renderColorOption}
                                />
                            </View>
                        )}

                        {/* Size Selection */}
                        {hasSizes && (
                            <View style={styles.variationBlock}>
                                <View style={styles.variationHeader}>
                                    <Text style={styles.variationLabel}>Size</Text>
                                    <TouchableOpacity
                                        style={styles.sizeGuideLink}
                                        onPress={() => setSizeChartOpen(true)}
                                    >
                                        <Icon name="resize-outline" size={16} color={THEME.p1} />
                                        <Text style={styles.sizeGuideLinkText}>Size Guide</Text>
                                    </TouchableOpacity>
                                </View>
                                <View style={styles.sizeGrid}>
                                    {productSizes.map((sizeItem) => (
                                        <TouchableOpacity
                                            key={sizeItem.id}
                                            style={[
                                                styles.sizeButton,
                                                selectedSize?.size === sizeItem.size && styles.sizeButtonSelected,
                                                !sizeItem.inStock && styles.sizeButtonDisabled
                                            ]}
                                            onPress={() => setSelectedSize(sizeItem)}
                                            disabled={!sizeItem.inStock}
                                        >
                                            {selectedSize?.size === sizeItem.size && (
                                                <LinearGradient
                                                    colors={[THEME.p1, THEME.p2]}
                                                    style={StyleSheet.absoluteFill}
                                                    start={{ x: 0, y: 0 }}
                                                    end={{ x: 1, y: 1 }}
                                                />
                                            )}
                                            <Text style={[
                                                styles.sizeButtonText,
                                                selectedSize?.size === sizeItem.size && styles.sizeButtonTextSelected,
                                                !sizeItem.inStock && styles.sizeButtonTextDisabled
                                            ]}>
                                                {sizeItem.size}
                                            </Text>
                                            {!sizeItem.inStock && (
                                                <View style={styles.outOfStockOverlay} />
                                            )}
                                        </TouchableOpacity>
                                    ))}
                                </View>
                            </View>
                        )}
                    </View>
                )}

                {/* PRODUCT DESCRIPTION */}
                <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Product Description</Text>
                    <Text style={styles.description}>{productDetails}</Text>
                </View>

                {/* PRODUCT POLICY */}
                {product.policy && (
                    <View style={styles.section}>
                        <TouchableOpacity
                            style={styles.policyButton}
                            onPress={() => setPolicyOpen(true)}
                        >
                            <Text style={styles.policyButtonText}>View Product Policy & Services</Text>
                            <Icon name="chevron-right" size={20} color={THEME.p1} />
                        </TouchableOpacity>
                    </View>
                )}

                {/* DELIVERY - BAHRAIN */}
                <View style={styles.section}>
                    <Text style={styles.sectionTitle}>Delivery - Bahrain</Text>
                    {deliveryOptions.map((option) => (
                        <TouchableOpacity
                            key={option.id}
                            style={[
                                styles.deliveryOption,
                                selectedDelivery === option.id && styles.deliveryOptionSelected
                            ]}
                            onPress={() => setSelectedDelivery(option.id)}
                        >
                            <View style={styles.deliveryInfo}>
                                <Text style={styles.deliveryName}>{option.name}</Text>
                                <Text style={styles.deliveryPrice}>{formatPrice(option.price)}</Text>
                            </View>
                            <View style={[
                                styles.radio,
                                selectedDelivery === option.id && styles.radioSelected
                            ]}>
                                {selectedDelivery === option.id && <View style={styles.radioDot} />}
                            </View>
                        </TouchableOpacity>
                    ))}
                </View>

                {/* RATING & REVIEWS */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <Text style={styles.sectionTitle}>Rating & Reviews</Text>
                        <TouchableOpacity onPress={() => setReviewsOpen(true)}>
                            <Text style={styles.seeAllText}>View All Reviews</Text>
                        </TouchableOpacity>
                    </View>
                    <View style={styles.ratingSummary}>
                        <Text style={styles.rating}>4/5</Text>
                        <Text style={styles.ratingCount}>({reviews.length} reviews)</Text>
                    </View>

                    {reviews.slice(0, 1).map((review) => (
                        <View key={review.id} style={styles.reviewItem}>
                            <View style={styles.reviewHeader}>
                                <Text style={styles.reviewUser}>{review.user}</Text>
                                <Text style={styles.reviewDate}>{review.date}</Text>
                            </View>
                            <View style={styles.ratingStars}>
                                {[1, 2, 3, 4, 5].map((star) => (
                                    <Icon
                                        key={star}
                                        name="star"
                                        size={16}
                                        color={star <= review.rating ? "#FFD700" : THEME.line}
                                    />
                                ))}
                            </View>
                            <Text style={styles.reviewComment}>{review.comment}</Text>
                        </View>
                    ))}
                </View>

                {/* MOST POPULAR */}
                <View style={styles.section}>
                    <View style={styles.sectionHeader}>
                        <Text style={styles.sectionTitle}>Most Popular</Text>
                        <TouchableOpacity>
                            <Text style={styles.seeAllText}>See All</Text>
                        </TouchableOpacity>
                    </View>
                    <FlatList
                        horizontal
                        data={popularProducts}
                        keyExtractor={(item) => item.id}
                        showsHorizontalScrollIndicator={false}
                        contentContainerStyle={styles.popularList}
                        renderItem={renderPopularProduct}
                    />
                </View>

                {/* PROMO BANNERS */}
                <View style={styles.promoSection}>
                    <ScrollView horizontal showsHorizontalScrollIndicator={false} contentContainerStyle={styles.promoList}>
                        {product.featured && <View style={styles.promoBanner}><Text style={styles.promoText}>Featured</Text></View>}
                        {product.best && <View style={styles.promoBanner}><Text style={styles.promoText}>Best Seller</Text></View>}
                        {product.hot && <View style={styles.promoBanner}><Text style={styles.promoText}>Hot</Text></View>}
                        {product.sale && <View style={styles.promoBanner}><Text style={styles.promoText}>Sale</Text></View>}
                        {product.trending && <View style={styles.promoBanner}><Text style={styles.promoText}>Trending</Text></View>}
                        {product.flash_deal && <View style={styles.promoBanner}><Text style={styles.promoText}>Flash Deal</Text></View>}
                    </ScrollView>
                </View>

                {/* YOU MIGHT LIKE */}
                <View style={styles.section}>
                    <Text style={styles.sectionTitle}>You Might Like</Text>
                    <View style={styles.productsGrid}>
                        {popularProducts.map((product) => (
                            <View key={product.id} style={styles.productCard}>
                                <Image source={{ uri: product.image }} style={styles.productImage} />
                                <Text style={styles.productName} numberOfLines={2}>{product.name}</Text>
                                <Text style={styles.productPrice}>{formatPrice(product.price)}</Text>
                            </View>
                        ))}
                    </View>
                </View>

                <View style={styles.bottomSpacer} />
            </ScrollView>
            <View style={styles.bottomActionBarSpacer} />

            {/* MODALS */}
            <SizeGuideModal />
            <ReviewsModal />
            <PolicyModal />

            {/* BOTTOM ACTION BAR */}
            <View style={styles.bottomActionBar}>
                {isInStock ? (
                    (cartQuantity > 0) ? (
                        <View style={styles.cartActions}>
                            <View style={styles.quantityControls}>
                                <TouchableOpacity
                                    style={styles.quantityBtn}
                                    onPress={handleDecreaseQuantity}
                                    activeOpacity={0.7}
                                >
                                    <Icon name="remove" size={20} color={THEME.ink} />
                                </TouchableOpacity>
                                <Text style={styles.quantityText}>{cartQuantity}</Text>
                                <TouchableOpacity
                                    style={[styles.quantityBtn, cartQuantity >= availableStock && styles.quantityBtnDisabled]}
                                    onPress={handleIncreaseQuantity}
                                    disabled={cartQuantity >= availableStock}
                                    activeOpacity={0.7}
                                >
                                    <Icon name="add" size={20} color={cartQuantity >= availableStock ? THEME.muted : THEME.ink} />
                                </TouchableOpacity>
                            </View>
                            <TouchableOpacity
                                style={styles.buyNowBtn}
                                onPress={handleBuyNow}
                                activeOpacity={0.9}
                            >
                                <LinearGradient
                                    colors={[THEME.p1, THEME.p2]}
                                    start={{ x: 0, y: 0 }}
                                    end={{ x: 1, y: 0 }}
                                    style={styles.buyNowGradient}
                                >
                                    <Text style={styles.buyNowText}>BUY NOW</Text>
                                    <Icon name="arrow-forward" size={18} color={THEME.white} />
                                </LinearGradient>
                            </TouchableOpacity>
                        </View>
                    ) : (
                        <TouchableOpacity
                            style={styles.addToCartBtn}
                            onPress={handleAddToCart}
                            disabled={isAddingToCart}
                            activeOpacity={0.9}
                        >
                            <LinearGradient
                                colors={[THEME.p1, THEME.p2]}
                                start={{ x: 0, y: 0 }}
                                end={{ x: 1, y: 0 }}
                                style={styles.addToCartGradient}
                            >
                                {isAddingToCart ? (
                                    <ActivityIndicator size="small" color={THEME.white} />
                                ) : (
                                    <>
                                        <Icon name="cart" size={20} color={THEME.white} />
                                        <Text style={styles.addToCartText}>ADD TO CART</Text>
                                    </>
                                )}
                            </LinearGradient>
                        </TouchableOpacity>
                    )
                ) : (
                    <TouchableOpacity style={styles.notifyBtn} activeOpacity={0.9}>
                        <LinearGradient
                            colors={[THEME.gray, THEME.muted]}
                            start={{ x: 0, y: 0 }}
                            end={{ x: 1, y: 0 }}
                            style={styles.notifyGradient}
                        >
                            <Icon name="notifications-outline" size={18} color={THEME.white} />
                            <Text style={styles.notifyText}>NOTIFY WHEN AVAILABLE</Text>
                        </LinearGradient>
                    </TouchableOpacity>
                )}
            </View>
        </View>
    );
};

export default ProductDetailScreen;

/* ------------------------ STYLES ------------------------ */
const createStyles = (THEME, isDark) => StyleSheet.create({
    safe: {
        flex: 1,
        backgroundColor: THEME.bg,
    },
    centerContent: {
        alignItems: 'center',
        justifyContent: 'center',
    },
    scrollView: {
        flex: 1,
    },

    /* HERO SECTION */
    heroWrap: {
        height: HERO_H,
        backgroundColor: THEME.bg,
        position: 'relative',
    },
    heroImageContainer: {
        width: W,
        height: HERO_H,
        justifyContent: 'center',
        alignItems: 'center',
        backgroundColor: THEME.bg,
    },
    heroImg: {
        width: '100%',
        height: '100%',
        resizeMode: 'cover'
    },
    imageIndicators: {
        position: 'absolute',
        bottom: 16,
        left: 0,
        right: 0,
        flexDirection: 'row',
        justifyContent: 'center',
        gap: 6,
        zIndex: 5,
    },
    indicatorDot: {
        width: 6,
        height: 6,
        borderRadius: 3,
        backgroundColor: isDark ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.2)',
    },
    indicatorDotActive: {
        width: 24,
        backgroundColor: isDark ? THEME.white : THEME.ink,
    },
    heroTopRow: {
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        paddingHorizontal: 16,
        paddingTop: Platform.OS === 'ios' ? 8 : 12,
        zIndex: 10,
    },
    headerRight: {
        flexDirection: 'row',
        gap: 8,
    },
    iconBtn: {
        width: 40,
        height: 40,
        borderRadius: 20,
        backgroundColor: THEME.card,
        alignItems: 'center',
        justifyContent: 'center',
        opacity: 0.95,
        ...Platform.select({
            ios: {
                shadowColor: '#000',
                shadowOffset: { width: 0, height: 2 },
                shadowOpacity: 0.12,
                shadowRadius: 8,
            },
            android: {
                elevation: 4,
            },
        }),
    },

    /* SECTIONS */
    section: {
        padding: 20,
        backgroundColor: THEME.card,
        borderBottomWidth: 1,
        borderBottomColor: THEME.line,
    },
    sectionHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 16,
    },
    sectionTitle: {
        fontSize: 20,
        fontWeight: '900',
        color: THEME.ink,
        marginBottom: 4,
    },

    /* PRODUCT INFO */
    priceRow: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 12,
    },
    priceContainer: {
        flexDirection: 'row',
        alignItems: 'baseline',
        gap: 12,
    },
    price: {
        fontSize: 28,
        fontWeight: '900',
        color: THEME.ink,
    },
    originalPrice: {
        fontSize: 18,
        color: THEME.muted,
        textDecorationLine: 'line-through',
        fontWeight: '600',
    },
    discountBadge: {
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 8,
    },
    discountText: {
        color: THEME.white,
        fontSize: 13,
        fontWeight: '800',
    },
    productTitle: {
        fontSize: 20,
        fontWeight: '800',
        color: THEME.ink,
        lineHeight: 28,
        marginBottom: 16,
    },
    metaRow: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 12,
    },
    skuBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
        paddingHorizontal: 12,
        paddingVertical: 6,
        backgroundColor: THEME.bg,
        borderRadius: 8,
    },
    productSku: {
        fontSize: 12,
        color: THEME.gray,
        fontWeight: '600',
    },
    stockBadge: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
        paddingHorizontal: 12,
        paddingVertical: 6,
        borderRadius: 8,
    },
    stockBadgeIn: {
        backgroundColor: THEME.success + '20',
    },
    stockBadgeOut: {
        backgroundColor: THEME.red + '20',
    },
    stockText: {
        fontSize: 12,
        fontWeight: '700',
    },
    inStock: {
        color: THEME.success,
    },
    outOfStock: {
        color: THEME.red,
    },

    /* VARIATIONS */
    variationBlock: {
        marginBottom: 24,
    },
    variationHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 12,
    },
    variationLabel: {
        fontSize: 16,
        fontWeight: '800',
        color: THEME.ink,
    },
    selectedVariationText: {
        fontSize: 14,
        fontWeight: '700',
        color: THEME.p1,
    },
    colorsList: {
        paddingVertical: 4,
    },
    colorOption: {
        alignItems: 'center',
        marginRight: 16,
        padding: 8,
    },
    colorOptionSelected: {
        backgroundColor: THEME.bg,
        borderRadius: 12,
        padding: 8,
    },
    colorCircleWrapper: {
        position: 'relative',
        marginBottom: 8,
    },
    colorCircle: {
        width: 48,
        height: 48,
        borderRadius: 24,
        borderWidth: 3,
        borderColor: THEME.line,
    },
    colorCheckmark: {
        position: 'absolute',
        bottom: -2,
        right: -2,
        width: 20,
        height: 20,
        borderRadius: 10,
        backgroundColor: THEME.p1,
        alignItems: 'center',
        justifyContent: 'center',
        borderWidth: 2,
        borderColor: THEME.white,
    },
    colorText: {
        fontSize: 12,
        fontWeight: '600',
        color: THEME.gray,
        maxWidth: 64,
        textAlign: 'center',
    },
    colorTextSelected: {
        color: THEME.p1,
        fontWeight: '800',
    },

    /* SIZE SECTION */
    sizeGuideLink: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 6,
        paddingHorizontal: 10,
        paddingVertical: 6,
        backgroundColor: THEME.bg,
        borderRadius: 8,
    },
    sizeGuideLinkText: {
        fontSize: 13,
        color: THEME.p1,
        fontWeight: '700',
    },
    sizeGrid: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        gap: 10,
    },
    sizeButton: {
        minWidth: 64,
        height: 48,
        borderWidth: 2,
        borderColor: THEME.line,
        borderRadius: 12,
        alignItems: 'center',
        justifyContent: 'center',
        backgroundColor: THEME.card,
        position: 'relative',
        overflow: 'hidden',
    },
    sizeButtonSelected: {
        borderColor: THEME.p1,
    },
    sizeButtonDisabled: {
        borderColor: THEME.line,
        backgroundColor: THEME.bg,
        opacity: 0.5,
    },
    sizeButtonText: {
        fontSize: 15,
        fontWeight: '800',
        color: THEME.ink,
        zIndex: 1,
    },
    sizeButtonTextSelected: {
        color: THEME.white,
    },
    sizeButtonTextDisabled: {
        color: THEME.muted,
    },
    outOfStockOverlay: {
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        backgroundColor: 'rgba(0, 0, 0, 0.1)',
    },

    /* PRODUCT DESCRIPTION */
    description: {
        fontSize: 15,
        color: THEME.gray,
        lineHeight: 24,
        fontWeight: '400',
    },

    /* POLICY BUTTON */
    policyButton: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 16,
        backgroundColor: THEME.bg,
        borderRadius: 8,
        borderWidth: 1,
        borderColor: THEME.line,
    },
    policyButtonText: {
        fontSize: 16,
        fontWeight: '600',
        color: THEME.p1,
    },

    /* DELIVERY */
    deliveryOption: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 16,
        borderWidth: 1,
        borderColor: THEME.line,
        borderRadius: 8,
        marginBottom: 8,
        backgroundColor: THEME.card,
    },
    deliveryOptionSelected: {
        borderColor: THEME.p1,
        backgroundColor: THEME.bg,
    },
    deliveryInfo: {
        flex: 1,
    },
    deliveryName: {
        fontSize: 14,
        fontWeight: '600',
        color: THEME.ink,
        marginBottom: 4,
    },
    deliveryPrice: {
        fontSize: 14,
        color: THEME.gray,
    },
    radio: {
        width: 20,
        height: 20,
        borderRadius: 10,
        borderWidth: 2,
        borderColor: THEME.line,
        alignItems: 'center',
        justifyContent: 'center',
    },
    radioSelected: {
        borderColor: THEME.p1,
    },
    radioDot: {
        width: 10,
        height: 10,
        borderRadius: 5,
        backgroundColor: THEME.p1,
    },

    /* RATING & REVIEWS */
    ratingSummary: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 8,
        marginBottom: 16,
    },
    rating: {
        fontSize: 18,
        fontWeight: '700',
        color: THEME.ink,
    },
    ratingCount: {
        fontSize: 14,
        color: THEME.gray,
    },
    seeAllText: {
        fontSize: 14,
        color: THEME.p1,
        fontWeight: '600',
    },
    reviewItem: {
        padding: 16,
        backgroundColor: THEME.bg,
        borderRadius: 8,
    },
    reviewHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        marginBottom: 8,
    },
    reviewUser: {
        fontSize: 14,
        fontWeight: '600',
        color: THEME.ink,
    },
    reviewDate: {
        fontSize: 12,
        color: THEME.gray,
    },
    ratingStars: {
        flexDirection: 'row',
        marginBottom: 8,
    },
    reviewComment: {
        fontSize: 14,
        color: THEME.gray,
        lineHeight: 20,
    },

    /* MOST POPULAR */
    popularList: {
        paddingVertical: 8,
    },
    popularProductCard: {
        width: 140,
        marginRight: 16,
    },
    popularProductImage: {
        width: 140,
        height: 140,
        borderRadius: 8,
        marginBottom: 8,
        backgroundColor: THEME.bg,
    },
    popularProductName: {
        fontSize: 12,
        color: THEME.text,
        marginBottom: 4,
        lineHeight: 16,
    },
    popularProductPrice: {
        fontSize: 14,
        fontWeight: '700',
        color: THEME.ink,
    },

    /* PROMO BANNERS */
    promoSection: {
        padding: 20,
        backgroundColor: THEME.bg,
    },
    promoList: {
        flexDirection: 'row',
        gap: 12,
    },
    promoBanner: {
        paddingHorizontal: 16,
        paddingVertical: 8,
        backgroundColor: THEME.p1,
        borderRadius: 20,
    },
    promoText: {
        fontSize: 12,
        fontWeight: '700',
        color: THEME.white,
    },

    /* YOU MIGHT LIKE */
    productsGrid: {
        flexDirection: 'row',
        flexWrap: 'wrap',
        justifyContent: 'space-between',
        marginTop: 8,
    },
    productCard: {
        width: '48%',
        marginBottom: 16,
    },
    productImage: {
        width: '100%',
        height: 120,
        borderRadius: 8,
        marginBottom: 8,
        backgroundColor: THEME.bg,
    },
    productName: {
        fontSize: 12,
        color: THEME.text,
        marginBottom: 4,
        lineHeight: 16,
    },
    productPrice: {
        fontSize: 14,
        fontWeight: '700',
        color: THEME.ink,
    },

    /* BOTTOM ACTION BAR */
    bottomActionBar: {
        position: 'absolute',
        bottom: 0,
        left: 0,
        right: 0,
        paddingHorizontal: 16,
        paddingTop: 12,
        paddingBottom: Platform.OS === 'ios' ? 20 : 12,
        backgroundColor: THEME.card,
        borderTopWidth: 1,
        borderTopColor: THEME.line,
        zIndex: 1000,
        ...Platform.select({
            ios: {
                shadowColor: '#000',
                shadowOffset: { width: 0, height: -4 },
                shadowOpacity: 0.08,
                shadowRadius: 12,
            },
            android: {
                elevation: 12,
            },
        }),
    },
    cartActions: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 12,
        width: '100%',
    },
    quantityControls: {
        flexDirection: 'row',
        alignItems: 'center',
        gap: 16,
        backgroundColor: THEME.bg,
        paddingHorizontal: 12,
        paddingVertical: 8,
        borderRadius: 14,
        borderWidth: 1,
        borderColor: THEME.line,
        minWidth: 120,
    },
    quantityBtn: {
        width: 36,
        height: 36,
        borderRadius: 18,
        backgroundColor: THEME.card,
        alignItems: 'center',
        justifyContent: 'center',
        borderWidth: 1,
        borderColor: THEME.line,
    },
    quantityBtnDisabled: {
        backgroundColor: THEME.bg,
        opacity: 0.5,
    },
    quantityText: {
        fontSize: 17,
        fontWeight: '800',
        color: THEME.ink,
        minWidth: 32,
        textAlign: 'center',
    },
    addToCartBtn: {
        flex: 1,
        height: 56,
        borderRadius: 16,
        overflow: 'hidden',
    },
    addToCartGradient: {
        flex: 1,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        paddingHorizontal: 20,
    },
    addToCartText: {
        color: THEME.white,
        fontSize: 16,
        fontWeight: '800',
        letterSpacing: 0.5,
    },
    buyNowBtn: {
        flex: 1,
        height: 56,
        borderRadius: 16,
        overflow: 'hidden',
    },
    buyNowGradient: {
        flex: 1,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        paddingHorizontal: 20,
    },
    buyNowText: {
        color: THEME.white,
        fontSize: 16,
        fontWeight: '800',
        letterSpacing: 0.5,
    },
    notifyBtn: {
        flex: 1,
        height: 56,
        borderRadius: 16,
        overflow: 'hidden',
    },
    notifyGradient: {
        flex: 1,
        flexDirection: 'row',
        alignItems: 'center',
        justifyContent: 'center',
        gap: 8,
        paddingHorizontal: 20,
    },
    notifyText: {
        color: THEME.white,
        fontSize: 16,
        fontWeight: '800',
        letterSpacing: 0.5,
    },

    /* MODAL STYLES */
    modalOverlay: {
        flex: 1,
        backgroundColor: 'rgba(0, 0, 0, 0.5)',
        justifyContent: 'flex-end',
    },
    modalContent: {
        backgroundColor: THEME.card,
        borderTopLeftRadius: 16,
        borderTopRightRadius: 16,
        maxHeight: H * 0.8,
    },
    modalHeader: {
        flexDirection: 'row',
        justifyContent: 'space-between',
        alignItems: 'center',
        padding: 16,
        borderBottomWidth: 1,
        borderBottomColor: THEME.line,
    },
    modalTitle: {
        fontSize: 18,
        fontWeight: '700',
        color: THEME.ink,
    },
    closeButton: {
        padding: 4,
    },

    /* SIZE GUIDE MODAL */
    sizeGuideContent: {
        padding: 16,
    },
    sizeGuideText: {
        fontSize: 16,
        color: THEME.gray,
        marginBottom: 16,
        lineHeight: 22,
    },
    sizeTable: {
        borderWidth: 1,
        borderColor: THEME.line,
        borderRadius: 8,
        overflow: 'hidden',
        marginBottom: 16,
    },
    tableHeader: {
        flexDirection: 'row',
        backgroundColor: THEME.bg,
        borderBottomWidth: 1,
        borderBottomColor: THEME.line,
    },
    tableHeaderText: {
        flex: 1,
        padding: 12,
        fontSize: 14,
        fontWeight: '700',
        color: THEME.text,
        textAlign: 'center',
    },
    tableRow: {
        flexDirection: 'row',
        borderBottomWidth: 1,
        borderBottomColor: THEME.line,
    },
    tableCell: {
        flex: 1,
        padding: 12,
        fontSize: 14,
        color: THEME.gray,
        textAlign: 'center',
    },
    sizeTip: {
        flexDirection: 'row',
        alignItems: 'flex-start',
        gap: 8,
        padding: 12,
        backgroundColor: THEME.bg,
        borderRadius: 8,
        borderWidth: 1,
        borderColor: THEME.line,
    },
    sizeTipText: {
        fontSize: 14,
        color: THEME.p1,
        flex: 1,
        lineHeight: 20,
    },

    /* REVIEWS MODAL */
    reviewsContent: {
        padding: 16,
    },
    reviewsCount: {
        fontSize: 16,
        fontWeight: '600',
        color: THEME.ink,
        marginBottom: 16,
    },

    /* POLICY MODAL */
    policyContent: {
        padding: 16,
    },
    policyText: {
        fontSize: 14,
        color: THEME.gray,
        lineHeight: 22,
    },

    /* UTILITY STYLES */
    loadingContainer: {
        position: 'absolute',
        justifyContent: 'center',
        alignItems: 'center',
        zIndex: 1,
    },
    bottomSpacer: {
        height: 20,
    },
    bottomActionBarSpacer: {
        height: 80,
    },
    errorText: {
        color: THEME.ink,
        fontWeight: '700',
        fontSize: 16,
        marginBottom: 16,
    },
    retryButton: {
        backgroundColor: THEME.p1,
        paddingHorizontal: 24,
        paddingVertical: 12,
        borderRadius: 8,
    },
    retryButtonText: {
        color: THEME.white,
        fontWeight: '600',
        fontSize: 16,
    },
});