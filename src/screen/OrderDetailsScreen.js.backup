// src/screens/OrderDetailsScreen.js
import React from 'react';
import {
    View,
    Text,
    StyleSheet,
    SafeAreaView,
    ScrollView,
    Image,
    TouchableOpacity,
    Platform,
    Linking,
} from 'react-native';
import Ionicons from 'react-native-vector-icons/Ionicons';
import { useTheme } from '../context/ThemeContext';
import { useMemo } from 'react';
import { SkeletonListScreen } from '../components/SkeletonLoader';
import { useSkeletonLoader } from '../hooks/useSkeletonLoader';

const Section = ({ title, right, children, style, styles }) => (
    <View style={[styles.section, style]}>
        <View style={styles.sectionHead}>
            <Text style={styles.sectionTitle}>{title}</Text>
            {right ? <View>{right}</View> : <View style={{ width: 1 }} />}
        </View>
        {children}
    </View>
);

const InfoRow = ({ icon, label, value, onPress, COLORS, styles }) => (
    <TouchableOpacity disabled={!onPress} onPress={onPress} activeOpacity={onPress ? 0.7 : 1} style={styles.infoRow}>
        <View style={styles.infoRowLeft}>
            <Ionicons name={icon} size={18} color={COLORS.sub} />
            <Text style={styles.infoLabel}>{label}</Text>
        </View>
        <Text style={styles.infoValue} numberOfLines={1}>{value}</Text>
    </TouchableOpacity>
);

const CartItem = ({ item, styles }) => (
    <View style={styles.itemCard}>
        <Image source={item.image} style={styles.itemImg} />
        <View style={{ flex: 1, marginLeft: 10 }}>
            <Text numberOfLines={2} style={styles.itemTitle}>{item.title}</Text>
            {item.variant ? <Text style={styles.itemSub}>{item.variant}</Text> : null}
            <Text style={styles.itemSub}>Qty: {item.qty}</Text>
        </View>
        <Text style={styles.itemPrice}>{item.priceFmt}</Text>
    </View>
);

const Step = ({ index, label, active, last, COLORS, styles }) => (
    <View style={styles.stepRow}>
        <View style={styles.stepGutter}>
            {index !== 0 && <View style={[styles.stepLine, { backgroundColor: active ? COLORS.brand : COLORS.line }]} />}
            <View
                style={[
                    styles.stepDot,
                    active ? { backgroundColor: COLORS.brand, borderColor: COLORS.brand } : { backgroundColor: '#fff', borderColor: COLORS.line },
                ]}
            >
                {active ? <Ionicons name="checkmark" size={12} color="#fff" /> : null}
            </View>
            {!last && <View style={[styles.stepLine, { backgroundColor: active ? COLORS.brand : COLORS.line }]} />}
        </View>
        <View style={{ flex: 1 }}>
            <Text style={[styles.stepLabel, active && { color: COLORS.text, fontWeight: '800' }]}>{label}</Text>
        </View>
    </View>
);

const currency = (n, c = 'BD') => `${c} ${Number(n).toFixed(2)}`;

/* ---------- build a safe order from route params ---------- */
function buildOrder(orderFromParams) {
    const defaults = {
        id: 1,
        orderNumber: '#92287157',
        date: 'April, 06',
        status: 'Processing',
        steps: ['Ordered', 'Packed', 'Shipped', 'Out for delivery', 'Delivered'],
        currentStepIndex: 1,
        items: [
            { id: 'i1', title: 'Premium Cotton Tee', variant: 'Color: Black • Size: M', qty: 1, price: 14.99, priceFmt: currency(14.99), image: require('../assets/image1.png') },
            { id: 'i2', title: 'Classic Denim Jacket', variant: 'Color: Blue • Size: L', qty: 1, price: 42.0, priceFmt: currency(42), image: require('../assets/image2.png') },
        ],
        shipping: { name: 'Aarav Sharma', phone: '+91 90000 00000', address1: '221B, Baker Street', address2: 'Near City Mall', city: 'Mumbai', state: 'MH', zip: '400001', country: 'India' },
        payment: { method: 'VISA •••• 4242', billingSame: true },
        prices: { currency: 'BD', subtotal: 56.99, shipping: 0, discount: 5.0, tax: 2.85, total: 54.84 },
        tracking: { carrier: 'DHL', code: 'DH123456789', eta: 'Sep 03, 2025', url: '' },
        images: [],
    };

    const p = orderFromParams || {};
    // normalize number field name (orderNo → orderNumber)
    const orderNumber = p.orderNumber || p.orderNo || defaults.orderNumber;

    // synthesize items from images if caller didn’t pass items
    let items = Array.isArray(p.items) && p.items.length > 0 ? p.items : defaults.items;
    if ((!p.items || p.items.length === 0) && Array.isArray(p.images) && p.images.length) {
        items = p.images.slice(0, 4).map((uri, idx) => ({
            id: `img-${idx}`,
            title: `Item ${idx + 1}`,
            qty: 1,
            price: 0,
            priceFmt: currency(0, defaults.prices.currency),
            image: { uri },
        }));
    }

    const prices = { ...defaults.prices, ...(p.prices || {}) };
    const tracking = { ...defaults.tracking, ...(p.tracking || {}) };
    const shipping = { ...defaults.shipping, ...(p.shipping || {}) };
    const payment = { ...defaults.payment, ...(p.payment || {}) };

    const steps = Array.isArray(p.steps) && p.steps.length ? p.steps : defaults.steps;
    const currentStepIndex =
        typeof p.currentStepIndex === 'number' ? p.currentStepIndex :
            // map basic statuses to a step index if provided
            (p.status === 'Delivered' ? 4 : p.status === 'Out for delivery' ? 3 : p.status === 'Shipped' ? 2 : p.status === 'Packed' ? 1 : 0);

    return {
        ...defaults,
        ...p,
        orderNumber,
        items,
        prices,
        tracking,
        shipping,
        payment,
        steps,
        currentStepIndex,
    };
}

const OrderDetailsScreen = ({ route, navigation }) => {
    const { theme } = useTheme();
    const COLORS = {
        bg: theme.bg,
        text: theme.text,
        sub: theme.sub,
        line: theme.line,
        brand: theme.p1,
        brandSoft: theme.p4,
        chip: theme.line,
        card: theme.card,
    };
    const styles = useMemo(() => createStyles(COLORS), [COLORS]);
    const [loading, setLoading] = useSkeletonLoader(true, 600);

    React.useEffect(() => {
        const timer = setTimeout(() => setLoading(false), 800);
        return () => clearTimeout(timer);
    }, [setLoading]);

    const order = buildOrder(route?.params?.order);

    const P = order.prices;
    const steps = order.steps || [];
    const current = Math.max(0, Math.min(order.currentStepIndex ?? 0, steps.length - 1));

    if (loading) {
        return (
            <SafeAreaView style={styles.safe}>
                <SkeletonListScreen />
            </SafeAreaView>
        );
    }

    return (
        <SafeAreaView style={styles.safe}>
            {/* Header */}
            <View style={styles.header}>
                <TouchableOpacity onPress={() => navigation?.goBack?.()} style={styles.backBtn} activeOpacity={0.7}>
                    <Ionicons name="chevron-back" size={22} color={COLORS.text} />
                </TouchableOpacity>
                <Text style={styles.headerTitle}>Order Details</Text>
                <View style={{ width: 40, height: 40 }} />
            </View>

            <ScrollView contentContainerStyle={styles.body} showsVerticalScrollIndicator={false}>
                {/* Order summary strip */}
                <View style={styles.orderStrip}>
                    <View>
                        <Text style={styles.orderLabel}>Order</Text>
                        <Text style={styles.orderNo}>{order.orderNumber}</Text>
                    </View>
                    <View style={{ alignItems: 'flex-end' }}>
                        <Text style={styles.orderDate}>{order.date}</Text>
                        <View style={styles.statusChip}>
                            <Ionicons
                                name={order.status === 'Delivered' ? 'checkmark-circle' : order.status === 'Shipped' ? 'airplane' : 'cube'}
                                size={14}
                                color="#fff"
                                style={{ marginRight: 6 }}
                            />
                            <Text style={styles.statusChipText}>{order.status}</Text>
                        </View>
                    </View>
                </View>

                {/* Tracking */}
                <Section
                    title="Tracking"
                    styles={styles}
                    right={
                        order.tracking?.url ? (
                            <TouchableOpacity activeOpacity={0.7} onPress={() => Linking.openURL(order.tracking.url)}>
                                <Text style={styles.link}>View on carrier</Text>
                            </TouchableOpacity>
                        ) : null
                    }
                >
                    <InfoRow icon="airplane" label="Carrier" value={order.tracking?.carrier || '-'} COLORS={COLORS} styles={styles} />
                    <InfoRow icon="barcode" label="Tracking code" value={order.tracking?.code || '-'} COLORS={COLORS} styles={styles} />
                    <InfoRow icon="time-outline" label="Estimated delivery" value={order.tracking?.eta || '-'} COLORS={COLORS} styles={styles} />
                </Section>

                {/* Status timeline */}
                <Section title="Status" styles={styles}>
                    <View style={styles.stepsWrap}>
                        {steps.map((label, i) => (
                            <Step key={label} index={i} label={label} active={i <= current} last={i === steps.length - 1} COLORS={COLORS} styles={styles} />
                        ))}
                    </View>
                </Section>

                {/* Items */}
                <Section title="Items" styles={styles}>
                    {order.items.map((it) => (<CartItem key={it.id} item={it} styles={styles} />))}
                </Section>

                {/* Shipping */}
                <Section title="Shipping address" styles={styles} right={<Text style={styles.link}>Change</Text>}>
                    <Text style={styles.addrLine}>{order.shipping?.name}</Text>
                    <Text style={styles.addrLine}>{order.shipping?.phone}</Text>
                    <Text style={styles.addrLine}>{order.shipping?.address1}</Text>
                    {order.shipping?.address2 ? <Text style={styles.addrLine}>{order.shipping.address2}</Text> : null}
                    <Text style={styles.addrLine}>
                        {order.shipping?.city}, {order.shipping?.state} {order.shipping?.zip}
                    </Text>
                    <Text style={styles.addrLine}>{order.shipping?.country}</Text>
                </Section>

                {/* Payment */}
                <Section title="Payment" styles={styles}>
                    <InfoRow icon="card" label="Method" value={order.payment?.method || '-'} COLORS={COLORS} styles={styles} />
                    <InfoRow icon="home" label="Billing Address" value={order.payment?.billingSame ? 'Same as shipping' : 'Different address'} COLORS={COLORS} styles={styles} />
                </Section>

                {/* Price summary */}
                <Section title="Summary" styles={styles}>
                    <View style={styles.sumRow}><Text style={styles.sumLabel}>Subtotal</Text><Text style={styles.sumValue}>{currency(P.subtotal, P.currency)}</Text></View>
                    <View style={styles.sumRow}><Text style={styles.sumLabel}>Shipping</Text><Text style={styles.sumValue}>{P.shipping === 0 ? 'Free' : currency(P.shipping, P.currency)}</Text></View>
                    <View style={styles.sumRow}><Text style={styles.sumLabel}>Discount</Text><Text style={[styles.sumValue, { color: '#16A34A' }]}>-{currency(P.discount, P.currency)}</Text></View>
                    <View style={styles.sumRow}><Text style={styles.sumLabel}>Tax</Text><Text style={styles.sumValue}>{currency(P.tax, P.currency)}</Text></View>
                    <View style={[styles.sumRow, { marginTop: 8 }]}><Text style={styles.sumTotal}>Total</Text><Text style={styles.sumTotal}>{currency(P.total, P.currency)}</Text></View>
                </Section>

                <View style={{ height: 96 }} />
            </ScrollView>

            {/* Sticky bottom actions */}
            <View style={styles.bottomBar}>
                <TouchableOpacity style={[styles.bottomBtn, styles.ghostBtn]} activeOpacity={0.85}>
                    <Ionicons name="navigate-outline" size={18} color={COLORS.brand} style={{ marginRight: 6 }} />
                    <Text style={styles.bottomGhostText}>Track Package</Text>
                </TouchableOpacity>

                <TouchableOpacity style={[styles.bottomBtn, styles.ghostBtn]} activeOpacity={0.85}>
                    <Ionicons name="chatbubble-ellipses-outline" size={18} color={COLORS.brand} style={{ marginRight: 6 }} />
                    <Text style={styles.bottomGhostText}>Support</Text>
                </TouchableOpacity>

                <TouchableOpacity style={[styles.bottomBtn, styles.primaryBtn]} activeOpacity={0.9}>
                    <Ionicons name="refresh" size={18} color="#fff" style={{ marginRight: 6 }} />
                    <Text style={styles.primaryBtnText}>Re-Order</Text>
                </TouchableOpacity>
            </View>
        </SafeAreaView>
    );
};

export default OrderDetailsScreen;

/* ---------------- styles ---------------- */
const createStyles = (COLORS) => StyleSheet.create({
    safe: { flex: 1, backgroundColor: COLORS.bg },

    header: {
        paddingHorizontal: 16, paddingTop: 10, paddingBottom: 12,
        flexDirection: 'row', alignItems: 'center',
        borderBottomWidth: 1, borderBottomColor: COLORS.line,
        justifyContent: 'space-between',
    },
    backBtn: {
        width: 40, height: 40, borderRadius: 20,
        alignItems: 'center', justifyContent: 'center',
        backgroundColor: '#F3F4F6',
    },
    headerTitle: { flex: 1, textAlign: 'center', fontSize: 20, fontWeight: '800', color: COLORS.text },

    body: { paddingHorizontal: 16, paddingBottom: 12 },

    orderStrip: {
        marginTop: 14, marginBottom: 10,
        backgroundColor: COLORS.card, borderRadius: 16,
        borderWidth: 1, borderColor: COLORS.line,
        padding: 14, flexDirection: 'row',
        justifyContent: 'space-between', alignItems: 'center',
        ...Platform.select({
            ios: { shadowColor: '#000', shadowOpacity: 0.06, shadowRadius: 10, shadowOffset: { width: 0, height: 6 } },
            android: { elevation: 2 },
        }),
    },
    orderLabel: { color: COLORS.sub, fontSize: 12, fontWeight: '700' },
    orderNo: { color: COLORS.text, fontWeight: '900', fontSize: 16 },
    orderDate: { color: COLORS.sub, fontWeight: '700', marginBottom: 6 },
    statusChip: { flexDirection: 'row', alignItems: 'center', paddingHorizontal: 10, paddingVertical: 6, borderRadius: 999, backgroundColor: COLORS.brand },
    statusChipText: { color: '#fff', fontWeight: '800', fontSize: 12 },

    section: {
        backgroundColor: COLORS.card, borderRadius: 16,
        borderWidth: 1, borderColor: COLORS.line,
        padding: 14, marginTop: 12,
        ...Platform.select({
            ios: { shadowColor: '#000', shadowOpacity: 0.05, shadowRadius: 8, shadowOffset: { width: 0, height: 4 } },
            android: { elevation: 1 },
        }),
    },
    sectionHead: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', marginBottom: 10 },
    sectionTitle: { fontSize: 16, fontWeight: '900', color: COLORS.text },
    link: { color: COLORS.brand, fontWeight: '800' },

    infoRow: { paddingVertical: 10, flexDirection: 'row', alignItems: 'center', borderBottomWidth: 1, borderBottomColor: COLORS.line },
    infoRowLeft: { flexDirection: 'row', alignItems: 'center', gap: 8 },
    infoLabel: { marginLeft: 8, color: COLORS.sub, fontWeight: '700' },
    infoValue: { marginLeft: 'auto', color: COLORS.text, fontWeight: '700' },

    stepsWrap: { paddingTop: 6 },
    stepRow: { flexDirection: 'row', alignItems: 'flex-start' },
    stepGutter: { width: 24, alignItems: 'center' },
    stepLine: { width: 2, flex: 1 },
    stepDot: { width: 18, height: 18, borderRadius: 9, borderWidth: 2, alignItems: 'center', justifyContent: 'center' },
    stepLabel: { color: COLORS.sub, paddingBottom: 10, marginLeft: 8, paddingTop: 2 },

    itemCard: { flexDirection: 'row', alignItems: 'center', paddingVertical: 10, borderBottomWidth: 1, borderBottomColor: COLORS.line },
    itemImg: { width: 62, height: 62, borderRadius: 10 },
    itemTitle: { color: COLORS.text, fontWeight: '800' },
    itemSub: { color: COLORS.sub, marginTop: 2 },
    itemPrice: { marginLeft: 8, color: COLORS.text, fontWeight: '900' },

    addrLine: { color: COLORS.text, marginBottom: 4 },

    sumRow: { flexDirection: 'row', alignItems: 'center', justifyContent: 'space-between', paddingVertical: 6 },
    sumLabel: { color: COLORS.sub, fontWeight: '700' },
    sumValue: { color: COLORS.text, fontWeight: '800' },
    sumTotal: { color: COLORS.text, fontWeight: '900', fontSize: 16 },

    bottomBar: {
        position: 'absolute', left: 0, right: 0, bottom: 0,
        padding: 12, backgroundColor: '#FFFFFFF2',
        borderTopWidth: 1, borderTopColor: COLORS.line,
        flexDirection: 'row', alignItems: 'center', gap: 8,
    },
    bottomBtn: { flex: 1, height: 44, borderRadius: 12, flexDirection: 'row', alignItems: 'center', justifyContent: 'center' },
    ghostBtn: { backgroundColor: COLORS.brandSoft },
    bottomGhostText: { color: COLORS.brand, fontWeight: '800' },
    primaryBtn: { backgroundColor: COLORS.brand },
    primaryBtnText: { color: '#fff', fontWeight: '900' },
});
